# TP RT0707  

groupe 7:

|adresse ip|correspondance
|---|---|
|10.22.135.61|auto|
|10.22.135.62|moto|
|10.22.135.63|camion|
|10.22.135.64|passerelle
|10.22.135.65|evt|
|10.22.135.66|buffer|
|10.22.135.67|srv_web |
|10.22.135.68|srv_backup|


login:admin
password:Adm!n;23

login:root
password:1Rou!e;2


## Travail à réaliser

## installer et configurer les différents serveurs

### installation du serveur web apache
#### Srv_web
##### Installation du serveur Apache :
https://wiki.alpinelinux.org/wiki/Setting_Up_Apache_with_PHP

cat > /etc/apk/repositories << EOF
http://dl-cdn.alpinelinux.org/alpine/v/$(cat /etc/alpine-release | cut -d'.' -f1,2)/main
http://dl-cdn.alpinelinux.org/alpine/v/$(cat /etc/alpine-release | cut -d'.' -f1,2)/community
EOF

apk update

export phpverx=$(alpinever=$(cat /etc/alpine-release|cut -d '.' -f1);[ $alpinever -ge 9 ] && echo  7|| echo 5)

apk add apache2 php$phpverx-apache2

##### Test d'accès au site apache :
cd /var/www/localhost/htdocs

nano index.php

<?php
phpinfo();
?>

rc-service apache2 start

Aller sur la page apache par défaut pour voir si ça fonctionne : http://ip.ip.ip.ip/

Ajout d'Apache au démarrage :
rc-update add apache2



### installation du serveur MQTT

Installation d'un serveur MQTT mosquitto sur la passerelle:

* apk update
* apk add mosquitto
* service mosquitto start

installation du client nécessaire pour souscrire aux flux des véhicules

* apk add mosquitto-clients 


### installation des clients MQTT

Installation des clients MQTT mosquitto sur les devices (auto, moto, camion):

* apk add mosquitto-clients




## structure des messages échangés

**structure d'un message CAM:**
{
  "stationId": 1,
  "stationType": [
    5,
    10,
    15
  ],
  "vitesse": 100,
  "heading": "test ",
  "positionGPS": [
    "longitude": 121
    "latitude": 121
  ] 
}

**Structure d'un message DENM:**
{
  "stationId": 1,
  "stationType": [
    5
  ],
  "cause": 3,
  "subCause": "sous-type",
  "positionGPS": "49.260315,4.031164"
}


### tableau de référence des stationID

|stationID|véhicule correspondant|
|---|---|
1|auto
2|moto
3|camion




### création d'un subscriber sur auto


-q 1 : quality of service level to use for all messages. Defaults to 0.


**creation publisher pour CAM**

mosquitto_pub -h 10.22.135.64 -q 1 -u auto -t topic/auto/cam -m '{"stationId": 1,"stationType":[5,10,15],"vitesse":100.00,"heading": "test ","positionGPS": "48.8566969,2.3514616"}'



**creation publisher pour DENM**

mosquitto_pub -h 10.22.135.64 -q 1 -u auto -t topic/auto/denm -m '{"stationId":1 ,"stationType": [5],"cause": 3,"subCause":"sous-type","positionGPS": "49.260315,4.031164"}'


### création d'un subscriber sur moto

creation publisher  pour CAM

mosquitto_pub -h 10.22.135.64 -q 1 -u moto -t topic/moto/cam -m '{"stationId": 2,"stationType":[5,10,15],"vitesse":100.00,"heading": "test ","positionGPS": "48.8566969,2.3514616"}'

creation publisher pour DENM

mosquitto_pub -h 10.22.135.64 -q 1 -u moto -t topic/moto/denm -m '{"stationId":2 ,"stationType": [5],"cause": 3,"subCause":"sous-type","positionGPS": "49.260315,4.031164"}'



### création d'un subscriber sur camion

creation publisher  pour CAM

mosquitto_pub -h 10.22.135.64 -q 1 -u camion -t topic/camion/cam -m '{"stationId": 3,"stationType":[5,10,15],"vitesse":100.00,"heading": "test ","positionGPS": "48.8566969,2.3514616"}'


creation publisher pour DENM

mosquitto_pub -h 10.22.135.64 -q 1 -u camion -t topic/camion/denm -m '{"stationId":1 ,"stationType": [5],"cause": 3,"subCause":"sous-type","positionGPS": "49.260315,4.031164"}'


### La passerelle s'abonne aux flux des véhicules

abonnement aux flux des véhicules :

mosquitto_sub -h localhost -t topic/auto/cam -t topic/auto/denm -t topic/moto/cam -t topic/moto/denm -t topic/camion/cam -t topic/camion/denms





### NOTES
génération aléatoire entre 30 et 90 km/h







